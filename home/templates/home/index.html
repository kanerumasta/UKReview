{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}
{% load file_extras %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="p-6 bg-gray-50 min-h-screen">
    <!-- Greeting -->
    <h1 class="text-2xl font-semibold text-gray-800 mb-6">Welcome back, {{ request.user.first_name|default:request.user.username }} ðŸ‘‹</h1>

    <!-- Stats Cards -->
    <div class="grid grid-cols-5 mb-8 gap-4">
        <div class="bg-white rounded-2xl shadow p-5 flex items-center gap-4">
            <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                <i class="bi bi-grid-fill text-xl"></i>
            </div>
            <div>
                <p class="text-gray-500 text-sm">Active Jobs</p>
                <p class="text-xl font-bold text-gray-800">{{ active_jobs_count }}</p>
            </div>
        </div>
        <div class="bg-white rounded-2xl shadow p-5 flex items-center gap-4">
            <div class="p-3 rounded-full bg-green-100 text-green-600">
                <i class="bi bi-check-circle-fill text-xl"></i>
            </div>
            <div>
                <p class="text-gray-500 text-sm">Completed Jobs</p>
                <p class="text-xl font-bold text-gray-800">{{ completed_jobs_count }}</p>
            </div>
        </div>
		<div class="bg-white rounded-2xl shadow p-5 flex items-center gap-4">
			<div class="p-3 rounded-full bg-purple-100 text-purple-600">
				<i class="bi bi-server text-xl"></i>
			</div>
			<div>
				<p class="text-gray-500 text-sm">Remaining Jobs</p>
				<p class="text-xl font-bold text-gray-800">{{ remaining_jobs }}</p>
			</div>
		</div>
        <div class="bg-white rounded-2xl shadow p-5 flex items-center gap-4">
            <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                <i class="bi bi-hourglass-split text-xl"></i>
            </div>
            <div>
                <p class="text-gray-500 text-sm">On Hold</p>
                <p class="text-xl font-bold text-gray-800">{{ onhold_jobs_count }}</p>
            </div>
        </div>
        <div class="bg-white rounded-2xl shadow p-5 flex items-center gap-4">
            <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                <i class="bi bi-clock-history text-xl"></i>
            </div>
            <div>
                <p class="text-gray-500 text-sm">Total Hours</p>
                <p class="text-xl font-bold text-gray-800">{{ total_hours }}</p>
            </div>
        </div>
    </div>

    <!-- Charts + Productivity -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Jobs Overview Chart Placeholder -->
        <div class="bg-white rounded-2xl shadow p-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">Jobs Overview</h2>
    
    <div class="mb-4">
        <select id="jobs-filter" class="border rounded p-2 border-gray-100 outline-0">
            <option value="hourly" selected>Hourly</option>
            <option value="daily" >Daily</option>
            <option value="weekly">Weekly</option>
            <option value="monthly">Monthly</option>
        </select>
    </div>

    <canvas id="jobsOverviewChart" class="h-64 w-full"></canvas>
</div>

    

        <!-- Productivity Chart Placeholder -->
        <div class="bg-white rounded-2xl shadow p-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">Productivity</h2>
            <div class="h-64 flex items-center justify-center text-gray-400 border border-dashed rounded-lg">
                ðŸ“ˆ Chart Placeholder
            </div>
        </div>
    </div>

    <!-- Recent Jobs Table -->
    <div class="bg-white rounded-2xl shadow p-6">
        <h2 class="text-lg font-semibold text-gray-800 mb-4">Report Generations</h2>
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left text-gray-600">
                <thead class="bg-gray-100 text-gray-700 uppercase text-xs">
                    <tr>
                        <th class="px-4 py-3">Report ID</th>
                        <th class="px-4 py-3">Generated By</th>
                        <th class="px-4 py-3">Report Type</th>
						
                        <th class="px-4 py-3">Date Generated</th>
                        <th class="px-4 py-3">Filename</th>
                        <th class="px-4 py-3">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for report in generations %}
                    <tr class="report-row cursor-pointer hover:bg-green-50" data-url="{% url 'report_batch_detail' report.id %}" >
                        <td  class="px-4 py-3 font-medium text-gray-800">{{ report.id }}</td>
                        <!-- <td class="px-4 py-3">
                            {% if job.status == 'completed' %}
                                <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-700">{{ job.status }}</span>
                            {% elif job.status == 'active' %}
                                <span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-700">{{ job.status }}</span>
                            {% elif job.status == 'onhold' %}
                                <span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-700">{{ job.status }}</span>
                            {% else %}
                                <span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-600">{{ job.status }}</span>
                            {% endif %}
                        </td> -->
                        <td class="px-4 py-3 capitalize">{{ report.created_by }}</td>
                        <td class="px-4 py-3 capitalize">{{ report.batch_type }}</td>
                        <td class="px-4 py-3">{{ report.created_at|date:"M d, Y h:i A"|default:"-" }}</td>
                        <td class="px-4 py-3">{{ report.file.name|basename }}</td>
						<td class="px-4 py-3">
							{% if report.file %}
								<a href="{{ report.file.url }}" download title="Download"  onclick="event.stopPropagation()" class="bg-blue-100 text-blue-500 hover:opacity-80 font-bold text-xl rounded-full  text h-10 w-10 flex items-center justify-center ">
									<i class="bi bi-download"></i>
								</a>
							{% else %}
								-
							{% endif %}
						</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="px-4 py-6 text-center text-gray-400">No recent jobs found</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
<script>
document.addEventListener("DOMContentLoaded", function() {
    // Select all rows with the class "report-row"
    const rows = document.querySelectorAll(".report-row");

    rows.forEach(row => {
        row.addEventListener("click", function(e) {
            // Prevent row click if a download button was clicked
            if(e.target.closest(".download-btn")) return;

            // Redirect to the URL from the data attribute
            const url = row.dataset.url;
            if(url) {
                window.location.href = url;
            }
        });
    });
});
</script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const ctx = document.getElementById('jobsOverviewChart').getContext('2d');
    let jobsChart;

    async function fetchJobsData(filter) {
        const response = await fetch(`/api/jobs-overview/?filter=${filter}`);
        return await response.json();
    }

    async function updateChart(filter) {
        const data = await fetchJobsData(filter);

        if(jobsChart) jobsChart.destroy();  // Destroy previous chart

        jobsChart = new Chart(ctx, {
            type: 'bar',  // <-- Change to bar chart
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'Completed Jobs',
                    data: data.counts,
                    backgroundColor: 'rgba(59, 130, 246, 0.7)',
                    borderColor: 'rgba(59, 130, 246, 1)',
                    borderWidth: 1,
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: true },
                    tooltip: { mode: 'index', intersect: false }
                },
                scales: {
                    x: { 
                        display: true, 
                        title: { display: true, text: 'Time' },
                        ticks: { autoSkip: false, maxRotation: 45, minRotation: 0 }
                    },
                    y: { 
                        display: true, 
                        title: { display: true, text: 'Jobs Completed' },
                        beginAtZero: true 
                    }
                }
            }
        });
    }

    // Initial chart
    updateChart('hourly');

    // Handle filter change
    document.getElementById('jobs-filter').addEventListener('change', function() {
        updateChart(this.value);
    });
});
</script>

{% endblock %}
