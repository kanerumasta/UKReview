{% extends "base.html"%}

{% block content %}
<div class="p-6" x-data="{ tab: 'defects',editMode: false,
    openForm: false,
    
    checkTypes: [],
    defectOptions: {{ defect_options|safe }},
    selectedDefect: {
      id: 0,
      category: '',
      check_type: '',
      severity_level: '',
      issue_description: '',
      expected_outcome: '',
      actual_outcome: '',
      error_count: '',
      comments: ''
    } }">
  <!-- Title -->
  <h2 class="text-2xl font-bold flex items-center mb-6 text-gray-900">
    <i class="bi bi-file-earmark-text-fill mr-3 text-blue-500"></i>
    Reports
  </h2>

  <div x-effect="checkTypes = defectOptions[selectedDefect.category] || []"></div>
  <div class="flex items-center justify-between">

  <!-- Batch Selector -->
  <form method="get" class="flex items-center gap-4">
    <label for="batch" class="text-sm font-medium text-gray-700">Select Batch:</label>
    <select id="batch" name="batch" 
      onchange="this.form.submit()" 
      class="border border-gray-300 rounded-lg px-4 py-2 text-sm bg-white text-gray-700 shadow-sm focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
      <option value="">-- All Batches --</option>
      {% for b in batches %}
        <option value="{{ b.id }}" {% if selected_batch and selected_batch.id == b.id %}selected{% endif %}>
          {{ b.name }}
        </option>
      {% endfor %}
    </select>
  </form>
  <!-- Export Buttons -->
  <div class="my-6 flex gap-3">
    <a href="{% url 'partial_excel_report' %}?batch={{ selected_batch.id }}"
      class="px-4 py-2 bg-blue-400 hover:bg-blue-500 text-black  text-lg rounded-md shadow">
      <i class="bi bi-file-earmark-spreadsheet mr-1"></i>
      Generate Partial Report
    </a>
   <a href="{% url 'full_excel_report' %}?batch={{ selected_batch.id }}"
   class="px-4 py-2 text-white text-lg rounded-md shadow
          {% if selected_batch.all_jobs_completed %}
          bg-green-600 hover:bg-green-700
             
          {% else %}
               bg-gray-400 cursor-not-allowed pointer-events-none
          {% endif %}">
   <i class="bi bi-file-earmark-excel mr-1"></i>
   Generate Full Report
</a>
  </div>

  </div>
 


  <!-- Tabs -->
  <div class="w-full bg-white shadow rounded-lg">
    <div class="flex border-b border-gray-200 bg-gray-50 rounded-t-lg">
      <button @click="tab = 'defects'"
        :class="tab === 'defects' ? 'border-b-2 border-blue-500 text-blue-500 font-semibold' : 'text-gray-600'"
        class="px-6 py-3 text-sm focus:outline-none transition">
        Defects
      </button>
      <button @click="tab = 'summary'"
        :class="tab === 'summary' ? 'border-b-2 border-blue-500 text-blue-500 font-semibold' : 'text-gray-600'"
        class="px-6 py-3 text-sm focus:outline-none transition">
        Summary
      </button>
      <button @click="tab = 'enactments'"
        :class="tab === 'enactments' ? 'border-b-2 border-blue-500 text-blue-500 font-semibold' : 'text-gray-600'"
        class="px-6 py-3 text-sm focus:outline-none transition">
        Enactments
      </button>
    </div>

    <!-- Tab Contents -->
    <div class="p-4 max-w-full">
      <!-- Defects Tab -->
      <div x-show="tab === 'defects'">
              <h3 class="text-lg font-semibold mb-4 text-gray-800">Defects</h3>
              <form method="get" class="mb-4  flex gap-2 items-center">
          <input type="hidden" name="batch" value="{{ selected_batch.id }}">
          
          <input type="text" name="search" placeholder="Search defects..."
              value="{{ search_query }}"
              class="border border-gray-400 px-3 py-2 rounded-md text-sm shadow-sm focus:ring-1 focus:ring-blue-500 focus:border-blue-500">

          <select name="severity"
              class="border border-gray-400 px-3 py-2 rounded-md text-sm shadow-sm focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
              <option value="">-- All Severities --</option>
              <option value="1" {% if severity_filter == "1" %}selected{% endif %}>1</option>
              <option value="2" {% if severity_filter == "2" %}selected{% endif %}>2</option>
              <option value="3" {% if severity_filter == "3" %}selected{% endif %}>3</option>
              <option value="4" {% if severity_filter == "4" %}selected{% endif %}>4</option>
          </select>

          <button type="submit"
              class="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md text-sm shadow">
              Filter
          </button>
      </form>

        <div class="overflow-x-auto max-w-full rounded-lg shadow-sm ">
          <table class="min-w-full divide-y divide-gray-200 text-sm">
            <thead class="bg-gray-100 sticky top-0">
              <tr>
                <th class="px-3 py-2 text-left font-medium text-gray-700 uppercase tracking-wider">Defect ID</th>
                <th class="px-3 py-2 text-left font-medium text-gray-700 uppercase tracking-wider">Enactment Citation</th>
                <th class="px-3 py-2 text-left font-medium text-gray-700 uppercase tracking-wider">Provision Ref(s)</th>
                <th class="px-3 py-2 text-left font-medium text-gray-700 uppercase tracking-wider">Version Date</th>
                <th class="px-3 py-2 text-left font-medium text-gray-700 uppercase tracking-wider">Category</th>
                <th class="px-3 py-2 text-left font-medium text-gray-700 uppercase tracking-wider">Check Type</th>
                <th class="px-3 py-2 text-left font-medium text-gray-700 uppercase tracking-wider">Issue Description</th>
                <th class="px-3 py-2 text-left font-medium text-gray-700 uppercase tracking-wider">Expected Outcome</th>
                <th class="px-3 py-2 text-left font-medium text-gray-700 uppercase tracking-wider">Actual Outcome</th>
                <th class="px-3 py-2 text-left font-medium text-gray-700 uppercase tracking-wider">Severity</th>
                <th class="px-3 py-2 text-left font-medium text-gray-700 uppercase tracking-wider">Count Per Document</th>
                <th class="px-3 py-2 text-left font-medium text-gray-700 uppercase tracking-wider">Logged By</th>
                <th class="px-3 py-2 text-left font-medium text-gray-700 uppercase tracking-wider">Date Logged</th>
                <th class="px-3 py-2 text-left font-medium text-gray-700 uppercase tracking-wider">Comments</th>
                <th class="px-3 py-2 text-left font-medium text-gray-700 uppercase tracking-wider">Screenshot / Link</th>
                
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-100">
              {% for defect in defects %}
              <tr  @click="
              tab = 'defects';
              selectedDefect = {
                id: '{{ defect.id }}',
                category: '{{ defect.category|escapejs }}',
                check_type: '{{ defect.check_type|escapejs }}',
                severity_level: '{{ defect.severity_level|escapejs }}',
                issue_description: `{{ defect.issue_description|escapejs }}`,
                expected_outcome: `{{ defect.expected_outcome|escapejs }}`,
                actual_outcome: `{{ defect.actual_outcome|escapejs }}`,
                error_count: '{{ defect.error_count }}',
                comments: `{{ defect.comments|escapejs }}`
              };
              editMode = true;
              openForm = true;
            " class="hover:bg-gray-100 cursor-pointer transition">
                <td class="px-3 py-2 whitespace-nowrap">{{ defect.id }}</td>
                <td class="px-3 py-2">{{ defect.provision_job.enactment_assignment.enactment.title }}</td>
                <td class="px-3 py-2">{{ defect.provision_job.provision.title }}</td>
                <td class="px-3 py-2 whitespace-nowrap">{{ defect.provision_job.date }}</td>
                <td class="px-3 py-2">{{ defect.category }}</td>
                <td class="px-3 py-2">{{ defect.check_type }}</td>
                <td class="px-3 py-2">{{ defect.issue_description }}</td>
                <td class="px-3 py-2">{{ defect.expected_outcome }}</td>
                <td class="px-3 py-2">{{ defect.actual_outcome }}</td>
                <td class="px-3 py-2">{{ defect.severity_level }}</td>
                <td class="px-3 py-2">{{ defect.error_count }}</td>
                <td class="px-3 py-2">{{ defect.provision_job.user.email }}</td>
                <td class="px-3 py-2 whitespace-nowrap">{{ defect.created_at }}</td>
                <td class="px-3 py-2">{{ defect.comments }}</td>
                <td class="px-3 py-2">
                 {% if defect.screenshot_url %}
                  <a href="{{ defect.screenshot_url }}" target="_blank" class="text-blue-600 underline">
                    {{ defect.screenshot_url }}
                  </a>
                {% endif %}
                </td>
                

                    
              </tr>
              {% empty %}
              <tr>
                <td colspan="16" class="text-center text-gray-500 py-4">No defects found</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="mt-4 flex justify-center space-x-2">
    {% if defects.has_previous %}
        <a href="?batch={{ selected_batch.id }}&search={{ search_query }}&severity={{ severity_filter }}&page={{ defects.previous_page_number }}"
           class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Previous</a>
    {% endif %}

    <span class="px-3 py-1 bg-gray-100 rounded">
        Page {{ defects.number }} of {{ defects.paginator.num_pages }}
    </span>

    {% if defects.has_next %}
        <a href="?batch={{ selected_batch.id }}&search={{ search_query }}&severity={{ severity_filter }}&page={{ defects.next_page_number }}"
           class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Next</a>
    {% endif %}
</div>

      </div>

      <!-- Summary Tab -->
      <div x-show="tab === 'summary'" x-cloak>
        <div class="mt-8">
  <h3 class="text-lg font-bold mb-2">Summary</h3>

  <!-- Provision Errors -->
  <table class="table-auto border-collapse border border-gray-400 w-full mb-6">
    <tr class="bg-gray-200 font-semibold">
      <td class="border border-gray-400 px-4 py-2">% of Provisions with Error</td>
      <td class="border border-gray-400 px-4 py-2 text-center">{{ provision_error_rate|floatformat:2 }}%</td>
    </tr>
    <tr>
      <td class="border border-gray-400 px-4 py-2">Provisions with Error</td>
      <td class="border border-gray-400 px-4 py-2 text-center">{{ jobs_with_defects_count }}</td>
    </tr>
    <tr>
      <td class="border border-gray-400 px-4 py-2">Total Provisions</td>
      <td class="border border-gray-400 px-4 py-2 text-center">{{ jobs_total }}</td>
    </tr>
  </table>

  <!-- Severity Table -->
  <h4 class="font-semibold">Severity Levels</h4>
  <table class="table-auto border-collapse border border-gray-400 w-full mb-6">
    <thead class="bg-orange-200">
      <tr>
        <th class="border border-gray-400 px-4 py-2">Severity</th>
        <th class="border border-gray-400 px-4 py-2">Level</th>
        <th class="border border-gray-400 px-4 py-2">Error Count</th>
        <th class="border border-gray-400 px-4 py-2">Error Rate</th>
      </tr>
    </thead>
    <tbody>
      {% for level, count in severity_counts.items %}
      <tr>
        <td class="border border-gray-400 px-4 py-2">Severity</td>
        <td class="border border-gray-400 px-4 py-2">{{ level }}</td>
        <td class="border border-gray-400 px-4 py-2">{{ count }}</td>
        <td class="border border-gray-400 px-4 py-2">
          {% if severity_total %}{{ count|divisibleby:severity_total|floatformat:2 }}%{% else %}0%{% endif %}
        </td>
      </tr>
      {% endfor %}
      <tr class="font-bold bg-gray-100">
        <td colspan="2" class="border border-gray-400 px-4 py-2">Total</td>
        <td class="border border-gray-400 px-4 py-2">{{ severity_total }}</td>
        <td class="border border-gray-400 px-4 py-2">100%</td>
      </tr>
    </tbody>
  </table>

  <!-- Quality Table -->
  <h4 class="font-semibold">Quality Ratings</h4>
  <table class="table-auto border-collapse border border-gray-400 w-full">
    <thead class="bg-green-200">
      <tr>
        <th class="border border-gray-400 px-4 py-2">Rating</th>
        <th class="border border-gray-400 px-4 py-2">Rate Count</th>
        <th class="border border-gray-400 px-4 py-2">Percentage</th>
      </tr>
    </thead>
    <tbody>
      {% for rating, count in quality_counts.items %}
      <tr>
        <td class="border border-gray-400 px-4 py-2">{{ rating }}</td>
        <td class="border border-gray-400 px-4 py-2">{{ count }}</td>
        <td class="border border-gray-400 px-4 py-2">
          {% if quality_total %}{{ count|divisibleby:quality_total|floatformat:2 }}%{% else %}0%{% endif %}
        </td>
      </tr>
      {% endfor %}
      <tr class="font-bold bg-gray-100">
        <td class="border border-gray-400 px-4 py-2">Total</td>
        <td class="border border-gray-400 px-4 py-2">{{ quality_total }}</td>
        <td class="border border-gray-400 px-4 py-2">100%</td>
      </tr>
    </tbody>
  </table>
</div>

      </div>

      <!-- Enactments Tab -->
      <div x-show="tab === 'enactments'" x-cloak>
        <h3 class="text-lg font-semibold mb-3 text-gray-800">Enactments</h3>
        <div class="overflow-x-auto rounded-lg shadow-sm">
          <table class="min-w-full divide-y divide-gray-200 text-sm">
            <thead class="bg-gray-100 sticky top-0">
              <tr>
                <th class="px-3 py-2 text-left font-medium text-gray-700 uppercase tracking-wider">ID</th>
                <th class="px-3 py-2 text-left font-medium text-gray-700 uppercase tracking-wider">Title</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-100">
              {% for enactment in enactments %}
              <tr class="hover:bg-gray-50 transition">
                <td class="px-3 py-2">{{ enactment.id }}</td>
                <td class="px-3 py-2">{{ enactment.title }}</td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="2" class="text-center text-gray-500 py-4">No enactments found</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
<div x-show="editMode" x-cloak
     class="fixed inset-0 bg-black/30 flex items-center justify-center z-50 transition-opacity duration-300"
     x-transition:enter="ease-out duration-300"
     x-transition:enter-start="opacity-0"
     x-transition:enter-end="opacity-100"
     x-transition:leave="ease-in duration-200"
     x-transition:leave-start="opacity-100"
     x-transition:leave-end="opacity-0">
  
  <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-3xl overflow-y-auto transition-transform transform scale-95"
       x-transition:enter="ease-out duration-300"
       x-transition:enter-start="scale-95 opacity-0"
       x-transition:enter-end="scale-100 opacity-100"
       x-transition:leave="ease-in duration-200"
       x-transition:leave-start="scale-100 opacity-100"
       x-transition:leave-end="scale-95 opacity-0">
    
    <h2 class="text-2xl font-bold text-gray-900 mb-6">Edit Defect Log</h2>
    
    <form method="POST" :action="`/reports/${selectedDefect.id}/edit/`"  @submit.prevent="
          if (!selectedDefect.severity_level) {
              alert('Severity level is required');
              return;
          }
          $el.submit();
      " enctype="multipart/form-data" class="space-y-4">
      {% csrf_token %}
      <input type="hidden" name="defect_id" :value="selectedDefect.id">

      <!-- Grid Fields -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Category -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Category <span class="text-red-500">*</span></label>
          <select required name="category" x-model="selectedDefect.category"
                  @change="selectedDefect.check_type=''; selectedDefect.severity_level='';"
                  class="w-full border border-gray-300 px-3 py-2 rounded-lg focus:ring-2 focus:ring-blue-400 focus:outline-none">
            <option value="">-- Select Category --</option>
            {% for cat in defect_categories %}
              <option value="{{ cat.name }}" :selected="selectedDefect.category === '{{ cat.name }}'">
                {{ cat.name|capfirst }}
              </option>
            {% endfor %}
          </select>
          <div x-effect="checkTypes = defectOptions[selectedDefect.category] || []"></div>
        </div>

        <!-- Check Type -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Check Type <span class="text-red-500">*</span></label>
          <select required name="check_type" x-model="selectedDefect.check_type"
                  class="w-full border border-gray-300 px-3 py-2 rounded-lg focus:ring-2 focus:ring-blue-400 focus:outline-none"
                  @change="selectedDefect.severity_level = checkTypes.find(option => option.check_type === selectedDefect.check_type)?.severity_level || ''">
                 <!-- Placeholder option -->
              <option value="" disabled :selected="!selectedDefect.check_type">Select a check type</option>

            <template x-for="option in checkTypes" :key="option.check_type">
              <option :value="option.check_type" x-text="option.check_type"></option>
            </template>
          </select>
        </div>

        <!-- Severity -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Severity <span class="text-red-500">*</span></label>
          <input readonly required type="number" min="0" max="4" name="severity_level" x-model.number="selectedDefect.severity_level"
                 class="w-full border bg-gray-100 border-gray-300 px-3 py-2 rounded-lg focus:outline-none"/>
        </div>

        <!-- Error Count -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Error Count <span class="text-red-500">*</span></label>
          <input required type="number" name="error_count" x-model="selectedDefect.error_count"
                 class="w-full border border-gray-300 px-3 py-2 rounded-lg focus:ring-2 focus:ring-blue-400 focus:outline-none">
        </div>
      </div>

      <!-- Textareas -->
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Issue Description <span class="text-red-500">*</span></label>
          <textarea required name="issue_description" x-model="selectedDefect.issue_description"
                    class="w-full border border-gray-300 px-3 py-2 rounded-lg focus:ring-2 focus:ring-blue-400 focus:outline-none"></textarea>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Expected Outcome <span class="text-red-500">*</span></label>
          <textarea required name="expected_outcome" x-model="selectedDefect.expected_outcome"
                    class="w-full border border-gray-300 px-3 py-2 rounded-lg focus:ring-2 focus:ring-blue-400 focus:outline-none"></textarea>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Actual Outcome <span class="text-red-500">*</span></label>
          <textarea required name="actual_outcome" x-model="selectedDefect.actual_outcome"
                    class="w-full border border-gray-300 px-3 py-2 rounded-lg focus:ring-2 focus:ring-blue-400 focus:outline-none"></textarea>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Comments</label>
          <textarea name="comments" x-model="selectedDefect.comments"
                    class="w-full border border-gray-300 px-3 py-2 rounded-lg focus:ring-2 focus:ring-blue-400 focus:outline-none"></textarea>
        </div>
      </div>

      <!-- Screenshot -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Screenshot</label>
        <input type="file" accept="image/*" name="screenshot"
               class="w-full border border-gray-300 px-3 py-2 rounded-lg focus:ring-2 focus:ring-blue-400 focus:outline-none">
      </div>

      <!-- Buttons -->
      <div class="flex justify-end gap-4 mt-6">
        <button type="button" @click="editMode = false"
                class="bg-gray-200 text-gray-800 px-5 py-2 rounded-lg hover:bg-gray-300 transition">
          Cancel
        </button>
        <button type="submit"
                class="bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 transition">
          Save
        </button>
      </div>
    </form>
  </div>
</div>


</div>



{% endblock %}
