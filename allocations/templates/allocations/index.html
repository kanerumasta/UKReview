{% extends "base.html" %}
{% block content %}

{% if messages %}
<div id="message-container" class="w-full px-6 mt-6">
    {% for message in messages %}
    <div class="mb-4 px-4 py-3 rounded-lg text-black
                {% if message.tags == 'error' %}bg-red-300{% endif %}
                {% if message.tags == 'success' %}bg-green-300{% endif %}">
        {{ message }}
    </div>
    {% endfor %}
</div>

<script>
    // Auto-hide messages after 3 seconds (3000ms)
    setTimeout(() => {
        const container = document.getElementById('message-container');
        if (container) {
            container.style.transition = "opacity 0.5s";
            container.style.opacity = 0;
            setTimeout(() => container.remove(), 500); // remove after fade out
        }
    }, 3000);
</script>
{% endif %}

<div class="p-6" 
     x-data="{ 
        reassignMode: true, 
        selectedJobs: [], 
        showModal: false, 
        toggleJob(id) { 
            if(this.selectedJobs.includes(id)) {
                this.selectedJobs = this.selectedJobs.filter(j => j !== id);
            } else {
                this.selectedJobs.push(id);
            }
           
        } 
     }">

  <h1 class="text-2xl font-bold mb-6 text-gray-700">Allocations</h1>

  <!-- Filters -->
  <form method="get" class="flex flex-wrap gap-4 mb-6 items-center" id="filters-form">
    <select name="user" class="border border-gray-300 px-3 py-2 rounded-md focus:ring-2 focus:ring-blue-400 focus:outline-none">
      <option value="">All Users</option>
      {% for u in users %}
      <option value="{{ u.id }}" {% if selected_user == u.id|stringformat:'s' %}selected{% endif %}>{{ u.get_fullname|default:u.username }}</option>
      {% endfor %}
    </select>
  <select name="status" class="border border-gray-300 px-3 py-2 rounded-md focus:ring-2 focus:ring-blue-400 focus:outline-none">
    <option value="all">All Status</option>
    {% for s, label in status_choices %}
        <option value="{{ s }}" {% if selected_status == s %}selected{% endif %}>{{ label }}</option>
    {% endfor %}
</select>

  </form>

  <!-- Jobs Table -->
  <form method="post" class="overflow-x-auto bg-white shadow-lg p-6 rounded-lg">
    {% csrf_token %}
    <table class="min-w-full divide-y divide-gray-200 rounded-lg">
      <thead class="bg-gray-100">
        <tr>
          <th></th>
          <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">User</th>
          <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Job ID</th>
          <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Provision</th>
          <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Enactment</th>
          <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Status</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        {% for job in page_obj %}
        <tr class="hover:bg-gray-50 transition cursor-pointer"
            @click="toggleJob({{ job.id }})">
          <td class="px-6 py-4">
            <input type="checkbox" name="jobs" value="{{ job.id }}" 
                   x-show="reassignMode"
                   x-model="selectedJobs"
                   @click.stop
                   class="form-checkbox h-5 w-5 text-blue-600 rounded">
          </td>
          <td class="px-6 py-4 text-gray-700 capitalize">
            {% if job.user %}
              {{ job.user.get_fullname }}
            {% else %}
              <span class="text-gray-400 italic">Unassigned</span>
            {% endif %}
          </td>
          <td class="px-6 py-4 font-medium text-gray-700">JOB-{{ job.id }}</td>
          <td class="px-6 py-4 text-gray-600">{{ job.provision.title }}</td>
          <td class="px-6 py-4 text-gray-600">{{ job.enactment_assignment.enactment.title }}</td>
          
          <td class="px-6 py-4">
            <span class="px-3 py-1 rounded-full text-xs font-semibold 
                         {% if job.status == 'pending' %}bg-gray-100 text-gray-700
                         {% elif job.status == 'active' %}bg-blue-100 text-blue-700
                         {% elif job.status == 'onhold' %}bg-yellow-100 text-yellow-700
                         {% elif job.status == 'completed' %}bg-green-100 text-green-700
                         {% endif %}">
              {{ job.status|capfirst }}
            </span>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="6" class="px-6 py-4 text-center text-gray-400 italic">No jobs found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- Pagination (same as before) -->
    <div class="mt-6 flex justify-center items-center space-x-2">
      {% if page_obj.has_previous %}
        <a href="?{% if selected_user %}user={{ selected_user }}&{% endif %}{% if selected_status %}status={{ selected_status }}&{% endif %}page={{ page_obj.previous_page_number }}" 
           class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 transition">Previous</a>
      {% else %}
        <span class="px-3 py-1 bg-gray-100 rounded text-gray-400 cursor-not-allowed">Previous</span>
      {% endif %}

      {% for num in page_obj.paginator.page_range %}
        {% if page_obj.number == num %}
          <span class="px-3 py-1 bg-blue-600 text-white rounded">{{ num }}</span>
        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
          <a href="?{% if selected_user %}user={{ selected_user }}&{% endif %}{% if selected_status %}status={{ selected_status }}&{% endif %}page={{ num }}" 
             class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 transition">{{ num }}</a>
        {% endif %}
      {% endfor %}

      {% if page_obj.has_next %}
        <a href="?{% if selected_user %}user={{ selected_user }}&{% endif %}{% if selected_status %}status={{ selected_status }}&{% endif %}page={{ page_obj.next_page_number }}" 
           class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 transition">Next</a>
      {% else %}
        <span class="px-3 py-1 bg-gray-100 rounded text-gray-400 cursor-not-allowed">Next</span>
      {% endif %}
    </div>

    <!-- Reassign Button -->
    <div class="mt-4" x-show="selectedJobs.length > 0">
      <button type="button" @click="showModal = true" 
              class="bg-blue-500 hover:bg-blue-400 text-white p-6 py-2 rounded-md shadow-md transition">
        Reallocate Selected (<span x-text="selectedJobs.length"></span>)
      </button>
    </div>

    <!-- Modal (same as before) -->
    <div x-show="showModal" x-transition.opacity class="fixed inset-0 flex items-center justify-center shadow-lg bg-black/10 bg-opacity-50 z-100">
      <div class="bg-white rounded-lg p-6 w-96 shadow-xl border  border-gray-400">
        <h2 class="text-lg font-bold mb-4 text-gray-700">Reallocate Jobs To</h2>
        <label class="block mb-2 text-gray-600 font-medium">Select User:</label>
        <select name="reassign_to" class="w-full border border-gray-300 px-3 py-2 rounded-md focus:ring-2 focus:ring-blue-400 focus:outline-none mb-4">
          {% for u in users.exc %}
            {% if u.id != request.user.id %}
      <option value="{{ u.id }}">{{ u.get_full_name|default:u.username }}</option>
    {% endif %}

          {% endfor %}
        </select>
        <div class="flex justify-end space-x-2">
          <button type="button" @click="showModal = false" 
                  class="px-4 py-2 bg-gray-300 hover:bg-gray-400 rounded-md transition">Cancel</button>
          <button type="submit" 
                  class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md shadow-md transition">Confirm</button>
        </div>
      </div>
    </div>

  </form>
</div>
<script>
document.addEventListener("DOMContentLoaded", function() {
    const form = document.getElementById('filters-form');
    const selects = form.querySelectorAll('select');

    selects.forEach(select => {
        select.addEventListener('change', () => {
            form.submit();
        });
    });
});
</script>

{% endblock %}
