{% extends "base.html" %}

{% block content %}

<div class="w-full max-w-13xl mx-auto p-3 bg-white rounded-lg shadow">
    <!-- Page Header -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-left mb-6 space-y-2 md:space-y-0">
        <h1 class="text-2xl font-semibold">User Productivity Report</h1>
        <a href="{% url 'export_to_excel' %}?{{ request.GET.urlencode }}" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded shadow">Export To Excel</a>
    </div>

    <!-- Filter Form -->
    <form method="GET" class="flex items-center space-x-2 mb-4">
        <label for="start_date" class="font-medium">Filter by:</label>
        
        <!-- User dropdown -->
     <select name="user_id" id="user_id" class="border rounded px-2 py-1">
        <option value="">All Users</option>
        {% for u in users %}
            <option value="{{ u.id }}" {% if request.GET.user_id == u.id|stringformat:"s" %}selected{% endif %}>
                {{ u.username }}
            </option>
        {% endfor %}
    </select>


        <input type="date" name="start_date" id="start_date" value="{{ request.GET.start_date }}" class="border rounded px-2 py-1">
        <input type="date" name="end_date" id="end_date" value="{{ request.GET.end_date }}" class="border rounded px-2 py-1">
        <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-1 rounded">Search</button>



        <!-- Clear filter button -->
        <a href="{% url 'productivity_index' %}" class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-1 rounded">Clear</a>
    
    
    </form>

    <!-- Search Form aligned to Efficiency column -->
    <div class="flex justify-end pr-4 mb-2">
        <form method="GET" class="flex items-center space-x-2">
            <input type="text" name="q" value="{{ request.GET.q }}"
                placeholder="Search..."
                class="border rounded px-2 py-1 w-64">
            <button type="submit"
                    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-1 rounded">
                Search
            </button>
        </form>
    </div>

    

    <!-- Table -->
    <div class="overflow-x-auto border rounded-lg">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-100 sticky top-0">
                <tr>
                    <th class="px-4 py-2 text-left text-gray-700 font-semibold">Date Assigned</th>
                    <th class="px-4 py-2 text-left text-gray-700 font-semibold">User ID</th>
                    <th class="px-4 py-2 text-left text-gray-700 font-semibold">User Name</th>
                    <th class="px-4 py-2 text-left text-gray-700 font-semibold">Enactment</th>
                    <th class="px-4 py-2 text-left text-gray-700 font-semibold">Provision Ref(s)</th>
                    <th class="px-4 py-2 text-left text-gray-700 font-semibold">Start Date</th>
                    <th class="px-4 py-2 text-left text-gray-700 font-semibold">End Date</th>
                    <th class="px-4 py-2 text-left text-gray-700 font-semibold">Time Spent (hrs)</th>
                    <th class="px-4 py-2 text-left text-gray-700 font-semibold">Efficiency (%)</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% if productivity_data %}
                    {% for row in productivity_data %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-2">{{ row.task_date|date:"m/d/Y"}}</td>
                        <td class="px-4 py-2">{{ row.user_name }}</td>
                        <td class="px-4 py-2">{{ row.employee_name }}</td>
                        <td class="px-4 py-2">{{ row.enactment }}</td>
                        <td class="px-4 py-2">{{ row.provision }}</td>
                        <td class="px-4 py-2">{{ row.start_time|date:"m/d/Y h:i A"}}</td>
                        <td class="px-4 py-2">{{ row.end_time|date:"m/d/Y h:i A"}}</td>
                        <td class="px-4 py-2">{{ row.time_spent }}</td>
                        <td class="px-4 py-2">{{ row.efficiency }}%</td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="9" class="py-4 text-center text-gray-500">No data available in table</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
<button onclick="exportTableToExcel()">Export to CSV</button>
    <script>
function exportTableToExcel() {
    try {
        const table = document.querySelector("table");

        // Convert table to JSON first (to keep exact text, e.g., "200%")
        let data = [];
        table.querySelectorAll("tr").forEach((row, i) => {
            let rowData = [];
            row.querySelectorAll("th, td").forEach(cell => {
                rowData.push(cell.innerText.trim());
            });
            data.push(rowData);
        });

        // Create worksheet from JSON
        let ws = XLSX.utils.aoa_to_sheet(data);

        // Apply auto-fit column widths
        let colWidths = data[0].map((_, colIndex) => {
            let maxWidth = 10;
            data.forEach(row => {
                if (row[colIndex]) {
                    let len = row[colIndex].toString().length;
                    if (len > maxWidth) maxWidth = len;
                }
            });
            return { wch: maxWidth + 2 };
        });
        ws['!cols'] = colWidths;

        // Create workbook
        let wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Report");

        // Dynamic filename: productivity_report_YYYYMMDD_HHMMSS.xlsx
        let now = new Date();
        let yyyy = now.getFullYear();
        let mm = String(now.getMonth() + 1).padStart(2, "0");
        let dd = String(now.getDate()).padStart(2, "0");
        let hh = String(now.getHours()).padStart(2, "0");
        let mi = String(now.getMinutes()).padStart(2, "0");
        let ss = String(now.getSeconds()).padStart(2, "0");

        let filename = `productivity_report_${yyyy}${mm}${dd}_${hh}${mi}${ss}.xlsx`;

        // Save Excel file
        XLSX.writeFile(wb, filename);

    } catch (error) {
        console.error("Export failed:", error);
        alert("Something went wrong while exporting.");
    }
}
</script>

    <!-- Pagination -->
        <div class="mt-4 flex justify-center space-x-2">
        {% if productivity_data.has_previous %}
            <a href="?page={{ productivity_data.previous_page_number }}"
            class="px-3 py-1 border rounded hover:bg-gray-200">Previous</a>
        {% endif %}

        {# show first page and ellipsis #}
        {% if productivity_data.number > 3 %}
            <a href="?page=1" class="px-3 py-1 border rounded hover:bg-gray-200">1</a>
            <span class="px-3 py-1">...</span>
        {% endif %}

        {# show current page -2 to +2 #}
        {% for num in productivity_data.paginator.page_range %}
            {% if num >= productivity_data.number|add:-2 and num <= productivity_data.number|add:2 %}
                {% if num == productivity_data.number %}
                    <span class="px-3 py-1 border rounded bg-blue-500 text-white">{{ num }}</span>
                {% else %}
                    <a href="?page={{ num }}" class="px-3 py-1 border rounded hover:bg-gray-200">{{ num }}</a>
                {% endif %}
            {% endif %}
        {% endfor %}

        {# show last page and ellipsis #}
        {% if productivity_data.number < productivity_data.paginator.num_pages|add:-2 %}
            <span class="px-3 py-1">...</span>
            <a href="?page={{ productivity_data.paginator.num_pages }}"
            class="px-3 py-1 border rounded hover:bg-gray-200">{{ productivity_data.paginator.num_pages }}</a>
        {% endif %}

        {% if productivity_data.has_next %}
            <a href="?page={{ productivity_data.next_page_number }}"
            class="px-3 py-1 border rounded hover:bg-gray-200">Next</a>
        {% endif %}
    </div>

</div>


{% endblock %}